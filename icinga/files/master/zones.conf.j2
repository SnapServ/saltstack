# Managed by SaltStack
object Zone "global" {
}

object Zone "master" {
    endpoints = [ "{{ grains['fqdn'] }}" ]
}

object Endpoint "{{ grains['fqdn'] }}" {
    host = "{{ grains['fqdn'] }}"
}

function RemoteNode(RemoteNodeName) {
    object Endpoint RemoteNodeName use (RemoteNodeName) {
        host = RemoteNodeName
    }

    object Zone RemoteNodeName use(RemoteNodeName) {
        endpoints = [ RemoteNodeName ]
        parent = "master"
    }
}

{%- set _nodes = salt['mine.get']('icinga:managed:true', 'grains.item', 'pillar') %}
{%- do _nodes.pop(grains['fqdn'], None) %}

{%- for _minion, _minion_grains in _nodes|dictsort %}
{%- if loop.first %}{{ '\n' }}{%- endif %}
RemoteNode("{{ _minion_grains['fqdn'] }}")
{%- endfor %}
{%- for _fqdn in vars.client_nodes|sort %}
RemoteNode("{{ _fqdn }}")
{%- endfor %}
